pipeline {
	agent {
        label 'catapult-build-node'
    }

    // using the Timestamper plugin we can add timestamps to the console log
    options {
        timestamps()
    }

    environment {
        DOCKER_REGISTRY = "249767383774.dkr.ecr.ap-southeast-1.amazonaws.com"
        CREDENTIAL_ID = "ecr:ap-southeast-1:jenkins-ecr"
        IMAGE = "proximax-catapult-server"
        BUILD_IMAGE = "proximax-catapult-server-dependencies-build-image:v1.0-buster"
    }

	stages {
		stage ('Build') {
            steps {
                echo 'Building catapult-server inside a docker'
                script {
                    def buildImage = docker.image("${BUILD_IMAGE}")
                    docker.withRegistry("https://${DOCKER_REGISTRY}", "${CREDENTIAL_ID}"){
                        buildImage.inside {
                            sh """
                                echo 'Building catapult-server'
                                rm -rf _build
                                mkdir _build 
                                cd _build
                                cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_CXX_FLAGS="-pthread" .. && \
                                make publish && \
                                make -j4 -k
                            """    
                        }
                    }
                }
            }
		}

        stage('Unit Test') {
            steps {
                sh """
                    echo 'Running unit tests'
                    # Disable exit on non 0
                    set +e
                    cd _build
                    # pipe to true to prevent exit failure
                    ctest -T Test --no-compress-output || true
                """
            }
            post {
                always {
                    archiveArtifacts "_build/bin/*"
                    xunit (
                        thresholds: [ skipped(failureThreshold: '0'), failed(failureThreshold: '0') ],
                        tools: [ CTest(pattern: "_build/Testing/**/*.xml") ]
                    )
                }
                success {
                    slackSend channel: '#devops',
                        color: 'good',
                        message: "Branch *${env.GIT_BRANCH}* build of *${currentBuild.fullDisplayName}* completed successfully :100:\n"
                }
                failure {
                    slackSend channel: '#devops',
                        color: 'bad',
                        message: "Branch *${env.GIT_BRANCH}* of *${currentBuild.fullDisplayName}* FAILED :scream:"
                }
            }
        }
    }
}